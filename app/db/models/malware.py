from app.db import db
from marshmallow import Schema, fields


class MalwareSchema(Schema):
    id = fields.Integer(required=False)
    url = fields.String()
    dtime = fields.DateTime(dump_default=None, allow_none=True)

    class Meta:
        fields = ("url",)


class BulkCreateMalwareSchema(Schema):
    malware_list = fields.List(fields.String(), required=True)


# Create Malware schema in urllookup table
# Table will be initialised when app is started
# Refer app.__init__.py - db.create_all()
class Malware(db.Model):
    __tablename__ = 'urllookup'
    __schema__ = MalwareSchema
    id = db.Column(db.Integer, primary_key=True)
    url = db.Column(db.String(200), unique=True)
    dtime = db.Column(db.DateTime, default=None)

    # Package the output into a struct and return
    @classmethod
    def _set_return_value(cls, data, is_safe):
        response = {
            "is_safe": is_safe,
            "data": {
                "url": f"http://{data['url']}" if is_safe else "Forbidden"
            }
        }
        return response
